pipeline{

  agent any

  tools {
    jdk 'JDK17-2'
    maven 'Maven3'
  }
  environment {
    APP_NAME = 'test-maven-pipeline'
    RELEASE = '1.0.0'
    DOCKER_USER = 'konyq'
    DOCKER_PASS ='dockerhub'
    IMAGE_NAME = '${DOCKER_USER}' + '/' + '${APP_NAME}'
    IMAGE_TAG = '${RELEASE}-${BUILD_NUMBER}'
  }

  stages {
    stage ('Cleanup Workspace'){
      steps{
        cleanWs()
      } 
    }
    stage('Checkout from SCM'){
      steps{
         git branch: 'main', changelog: false, credentialsId: 'Jenkins_agents', poll: false, url: 'https://github.com/DevOp-Edureka/sample-maven-project-2.git'
      }
    }
    stage('Build Application'){
      steps{
        bat 'mvn clean package'
      }
    }
stage('Sonarqube Analysis'){
    steps{
      script{
          withSonarQubeEnv(credentialsId:'jenkins-sonar-token'){
          bat 'mvn sonar:sonar'
           //bat instead of sh for windows run

        }
      } 
    }
  }
  stage('Quality Gate'){
    steps{
      script{
        waitForQualityGate abortPipeline: false, credentialsId: 'jenkins-sonar-token'
      }
    }
  }

  stage('Build and Push docker Image'){
    steps{
      script{
           withDockerRegistry(credentialsId: DOCKER_PASS, toolName: 'Docker-Latest'){
              docker_image = docker.build '${IMAGE_NAME}'
            }
            withDockerRegistry(credentialsId: DOCKER_PASS, toolName: 'Docker-Latest'){
              docker_image.push('${IMAGE_TAG}')
              docker_image.push('latest')
            }
      }
  }
}
}

}
